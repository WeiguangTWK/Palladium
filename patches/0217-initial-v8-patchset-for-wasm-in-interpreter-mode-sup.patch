From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Wed, 7 May 2025 16:15:37 +0000
Subject: [PATCH] initial v8 patchset for wasm in interpreter mode support

Wasm in interpreter mode is implemented via DrumBrake, maintained by the
Microsoft Edge DrumBrake WebAssembly developer team.
---
 ...e-Android-in-supported-platform-for-.patch | 22 +++++++++++++++
 ...e-support-for-32-bit-binary-compilat.patch | 28 +++++++++++++++++++
 2 files changed, 50 insertions(+)
 create mode 100644 vanadium/subprojects_patches/v8/0001-drumbrake-Include-Android-in-supported-platform-for-.patch
 create mode 100644 vanadium/subprojects_patches/v8/0002-drumbrake-disable-support-for-32-bit-binary-compilat.patch

diff --git a/vanadium/subprojects_patches/v8/0001-drumbrake-Include-Android-in-supported-platform-for-.patch b/vanadium/subprojects_patches/v8/0001-drumbrake-Include-Android-in-supported-platform-for-.patch
new file mode 100644
index 0000000000000..e44dadc838da0
--- /dev/null
+++ b/vanadium/subprojects_patches/v8/0001-drumbrake-Include-Android-in-supported-platform-for-.patch
@@ -0,0 +1,22 @@
+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
+From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
+Date: Wed, 7 Aug 2024 04:55:08 +0000
+Subject: [PATCH] drumbrake: Include Android in supported platform for wasm
+ interpreter
+
+---
+ gni/v8.gni | 1 +
+ 1 file changed, 1 insertion(+)
+
+diff --git a/gni/v8.gni b/gni/v8.gni
+index 4cb3301e..172c3605 100644
+--- a/gni/v8.gni
++++ b/gni/v8.gni
+@@ -326,6 +326,7 @@ is_drumbrake_supported =
+     (v8_current_cpu == "x64" || v8_current_cpu == "arm64" ||
+      v8_current_cpu == "riscv64") &&
+     (target_os == "win" || target_os == "linux" || target_os == "mac" ||
++     target_os == "android" ||
+      target_os == "ios")
+
+ # Turbofan is enabled by default, except in lite mode.
+
diff --git a/vanadium/subprojects_patches/v8/0002-drumbrake-disable-support-for-32-bit-binary-compilat.patch b/vanadium/subprojects_patches/v8/0002-drumbrake-disable-support-for-32-bit-binary-compilat.patch
new file mode 100644
index 0000000000000..a69e1dc1c26dc
--- /dev/null
+++ b/vanadium/subprojects_patches/v8/0002-drumbrake-disable-support-for-32-bit-binary-compilat.patch
@@ -0,0 +1,28 @@
+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
+From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
+Date: Wed, 7 Aug 2024 04:53:11 +0000
+Subject: [PATCH] drumbrake: disable support for 32-bit binary compilation
+
+---
+ BUILD.gn | 8 ++++++++
+ 1 file changed, 8 insertions(+)
+
+diff --git a/BUILD.gn b/BUILD.gn
+index 1bb7fc93c10..a37eba36c6b 100644
+--- a/BUILD.gn
++++ b/BUILD.gn
+@@ -552,6 +552,14 @@ if (v8_enable_snapshot_native_code_counters == "") {
+   v8_enable_snapshot_native_code_counters = v8_enable_debugging_features
+ }
+ 
++if (target_os == "android") {
++  if (v8_current_cpu == "arm" || v8_current_cpu == "x86") {
++    if (v8_enable_drumbrake) {
++      v8_enable_drumbrake = false
++    }
++  }
++}
++
+ if (v8_enable_drumbrake && v8_enable_webassembly) {
+   assert(
+       is_drumbrake_supported,
diff --git a/src/wasm/interpreter/wasm-interpreter-runtime.cc b/src/wasm/interpreter/wasm-interpreter-runtime.cc
index 68b5afcf..184e44ab 100644
--- a/src/wasm/interpreter/wasm-interpreter-runtime.cc
+++ b/src/wasm/interpreter/wasm-interpreter-runtime.cc
@@ -851,10 +851,10 @@ int32_t WasmInterpreterRuntime::AtomicNotify(uint64_t buffer_offset,
     HandleScope handle_scope(isolate_);
     // TODO(paolosev@microsoft.com): Support multiple memories.
     uint32_t memory_index = 0;
-    DirectHandle<JSArrayBuffer> array_buffer(wasm_trusted_instance_data()
-                                                 ->memory_object(memory_index)
-                                                 ->array_buffer(),
-                                             isolate_);
+    DirectHandle<WasmMemoryObject> memory_object(
+        wasm_trusted_instance_data()->memory_object(memory_index), isolate_);
+    DirectHandle<JSArrayBuffer> array_buffer =
+        WasmMemoryObject::GetArrayBuffer(isolate_, memory_object);
     int result = FutexEmulation::Wake(*array_buffer, buffer_offset, val);
     return result;
   }
@@ -870,9 +870,10 @@ int32_t WasmInterpreterRuntime::I32AtomicWait(uint64_t buffer_offset,
   HandleScope handle_scope(isolate_);
   // TODO(paolosev@microsoft.com): Support multiple memories.
   uint32_t memory_index = 0;
-  DirectHandle<JSArrayBuffer> array_buffer(
-      wasm_trusted_instance_data()->memory_object(memory_index)->array_buffer(),
-      isolate_);
+  DirectHandle<WasmMemoryObject> memory_object(
+      wasm_trusted_instance_data()->memory_object(memory_index), isolate_);
+  DirectHandle<JSArrayBuffer> array_buffer =
+      WasmMemoryObject::GetArrayBuffer(isolate_, memory_object);
   std::shared_ptr<BackingStore> backing_store = array_buffer->GetBackingStore();
   DCHECK_EQ(array_buffer->backing_store(), backing_store->buffer_start());
   auto result = FutexEmulation::WaitWasm32(isolate_, backing_store.get(),
@@ -890,9 +891,10 @@ int32_t WasmInterpreterRuntime::I64AtomicWait(uint64_t buffer_offset,
   HandleScope handle_scope(isolate_);
   // TODO(paolosev@microsoft.com): Support multiple memories.
   uint32_t memory_index = 0;
-  DirectHandle<JSArrayBuffer> array_buffer(
-      wasm_trusted_instance_data()->memory_object(memory_index)->array_buffer(),
-      isolate_);
+  DirectHandle<WasmMemoryObject> memory_object(
+      wasm_trusted_instance_data()->memory_object(memory_index), isolate_);
+  DirectHandle<JSArrayBuffer> array_buffer =
+      WasmMemoryObject::GetArrayBuffer(isolate_, memory_object);
   std::shared_ptr<BackingStore> backing_store = array_buffer->GetBackingStore();
   DCHECK_EQ(array_buffer->backing_store(), backing_store->buffer_start());
   auto result = FutexEmulation::WaitWasm64(isolate_, backing_store.get(),
